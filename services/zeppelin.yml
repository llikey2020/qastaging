variables:
  ZEPPELIN_SERVICE_NAME: zeppelin
  ZEPPELIN_PROJECT_ID: 38

Zeppelin helm prepare:
  extends:
    - .helm-prepare
  rules:
    - if: '($DEPLOY_PROJECT =~ /zeppelin/ || $DEPLOY_PROJECT == "all") && $ONLY_CLEANUP == "false"'
  variables:
    SERVICE_NAME: ${ZEPPELIN_SERVICE_NAME}
    PACKAGE_NAME: zeppelin-helm-chart
    FILE_NAME: zeppelin-0.1.0.tgz
    PACKAGE_VERSION: "0.1.0"
    ID: ${ZEPPELIN_PROJECT_ID}
  script:
    - !reference [".helm-prepare", "script"]
    - |
      cat << EOF > ${OVERRIDES_FILE}
      imagePullSecrets:
        - name: ${PULL_SECRET}
      image:
        repository: ${REGISTRY}/sequoiadp/zeppelin:${ZEPPELIN_IMAGE_TAG}
        pullPolicy: Always
      backendServices:
         - name: METASTORE
           value: ${SCHEMA_SERVICE_NAME}
         - name: METASTORE_NAMESPACE
           value: ${SERVICE_NAMESPACE}
         - name: SPARK_HISTORY_SERVER
           value: ${HISTORY_SERVICE_NAME}
         - name: SPARK_HISTORY_SERVER_NAMESPACE
           value: ${SERVICE_NAMESPACE}
         - name: ZEPPELIN
           value: zeppelin-server #${ZEPPELIN_SERVICE_NAME}
         - name: ZEPPELIN_NAMESPACE
           value: ${SERVICE_NAMESPACE}
      spark:
        repository: ${REGISTRY}/${SPARK_PROJECT}:${SPARK_IMAGE_TAG}
        imagePullSecret: ${PULL_SECRET}
        submitConfOptions:
          spark.jars: /spark/jars/spark-sequoiadb_3.0-3.2.0-SNAPSHOT.jar,/spark/jars/sequoiadb-driver-5.0.2.jar,/spark/jars/hadoop-aws-3.2.0.jar,/spark/jars/aws-java-sdk-bundle-1.11.375.jar
          spark.driver.extraJavaOptions: '-Dalluxio.master.rpc.addresses=${ALLUXIO_SVC}'
          spark.executor.extraJavaOptions: '-Dalluxio.master.rpc.addresses=${ALLUXIO_SVC}'
          spark.sql.warehouse.dir: alluxio:///${SPARK_WAREHOUSE}
          spark.hadoop.hive.metastore.uris: thrift://${SCHEMA_SVC}
          spark.eventLog.enabled: true
          spark.eventLog.dir: alluxio:///${SPARK_EVENTLOG_DIR}
          spark.sql.sequoiadp.metaservice.uri: ${METADATA_SVC}
      fullnameOverride: ${ZEPPELIN_SERVICE_NAME}
      serviceAccount:
        create: false
        name: ${SPARK_SERVICE_ACCOUNT}
      nginx:
        repository: ${CONTAINER_REGISTRY}nginx:1.14.0
      EOF
